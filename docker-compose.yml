services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.10
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ch_data:/var/lib/clickhouse
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  backfill:
    build: ./backfill
    depends_on:
      - clickhouse
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_DB: crypto
      CLICKHOUSE_TABLE: spot_klines_1m

      # 대상 심볼
      SYMBOLS: "BTCUSDT,ETHUSDT"

      # “과거 전부” 시작점(없으면 2017-01부터 시도, 없는 월은 404로 skip)
      START_YEAR: "2017"
      START_MONTH: "01"

      # 병렬 다운로드 설정
      DL_WORKERS: "8"
      BATCH_LINES: "80000"
      HTTP_TIMEOUT: "60"

      DOWNLOAD_DIR: "/data/downloads"
    volumes:
      - backfill_downloads:/data/downloads
    command: ["python", "backfill_spot_klines_1m.py"]

volumes:
  ch_data:
  backfill_downloads:
